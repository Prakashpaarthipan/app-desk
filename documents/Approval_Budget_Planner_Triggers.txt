CREATE OR REPLACE TRIGGER "TRANDATA"."APPROVAL_REQUEST_BUDGET" 
    AFTER
INSERT
OR UPDATE ON "APPROVAL_BUDGET_PLANNER" FOR EACH ROW declare
BEGIN
 if INSERTING then
     IF :NEW.APPMODE='N' THEN
        UPDATE BUDGET_PLANNER_YEARLY SET REQVALU=REQVALU+:NEW.APPRVAL WHERE BUDYEAR=:NEW.APRYEAR AND BUDMONTH=:NEW.APPMNTH AND BRNCODE=:NEW.BRNCODE AND TARNUMB=:NEW.TARNUMB;
     END IF;
--     IF :NEW.APPMODE='N' and :NEW.BUDMODE = 'R' THEN
--        UPDATE BUDGET_PLANNER_YEARLY SET RESVALU=RESVALU+:NEW.APPRVAL WHERE BUDYEAR=:NEW.APRYEAR AND BUDMONTH=:NEW.APPMNTH AND BRNCODE=:NEW.BRNCODE AND TARNUMB=:NEW.TARNUMB;
--     END IF;
--     IF :NEW.APPMODE='N' and :NEW.BUDMODE = 'E' THEN
--        UPDATE BUDGET_PLANNER_YEARLY SET EXTVALU=EXTVALU+:NEW.APPRVAL WHERE BUDYEAR=:NEW.APRYEAR AND BUDMONTH=:NEW.APPMNTH AND BRNCODE=:NEW.BRNCODE AND TARNUMB=:NEW.TARNUMB;
--     END IF;
 end if;

 if UPDATING then
     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' and :OLD.BUDMODE = 'F' THEN
         UPDATE BUDGET_PLANNER_YEARLY SET APPVALU=APPVALU+:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;
     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' and :OLD.BUDMODE = 'R' THEN
         UPDATE BUDGET_PLANNER_YEARLY SET RESVALU=RESVALU+:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;
     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' and :OLD.BUDMODE = 'E' THEN
         UPDATE BUDGET_PLANNER_YEARLY SET EXTVALU=EXTVALU+:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;

     IF :OLD.APPMODE='N' AND :NEW.DELETED='Y' THEN
        UPDATE BUDGET_PLANNER_YEARLY SET REQVALU=REQVALU-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB ;
     END IF;

     IF :OLD.APPMODE='Y' AND :NEW.DELETED='Y' and :OLD.BUDMODE = 'F' THEN
       UPDATE BUDGET_PLANNER_YEARLY SET APPVALU=APPVALU-:OLD.APPRVAL,REQVALU=REQVALU-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;

     IF :OLD.APPMODE='Y' AND :NEW.DELETED='Y' and :OLD.BUDMODE = 'R' THEN
       UPDATE BUDGET_PLANNER_YEARLY SET RESVALU=RESVALU-:OLD.APPRVAL,REQVALU=REQVALU-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;
     IF :OLD.APPMODE='Y' AND :NEW.DELETED='Y' and :OLD.BUDMODE = 'E' THEN
       UPDATE BUDGET_PLANNER_YEARLY SET EXTVALU=EXTVALU-:OLD.APPRVAL,REQVALU=REQVALU-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BUDMONTH=:OLD.APPMNTH AND BRNCODE=:OLD.BRNCODE AND TARNUMB=:OLD.TARNUMB;
     END IF;
 end if;
END;

==============================************************==================================


CREATE OR REPLACE TRIGGER "TRANDATA"."BUDGET_PLANNER_HEAD" AFTER
INSERT
OR UPDATE ON "APPROVAL_BUDGET_PLANNER" FOR EACH ROW declare
BEGIN
 if INSERTING then
     IF :NEW.APPMODE='N' AND ( :NEW.BUDMODE = 'F' or :NEW.BUDMODE = 'R' ) THEN
        UPDATE BUDGET_PLANNER_HEAD_SUM SET APPVALUE=APPVALUE+:NEW.APPRVAL WHERE BUDYEAR=:NEW.APRYEAR AND BRNCODE=:NEW.BRNCODE AND EXPSRNO=:NEW.EXPSRNO;
        UPDATE BUDGET_PLANNER_HEAD_SUM SET RESVALUE=BUDVALUE-APPVALUE WHERE BUDYEAR=:NEW.APRYEAR AND BRNCODE=:NEW.BRNCODE AND EXPSRNO=:NEW.EXPSRNO;
     END IF;
     IF :NEW.APPMODE='N' AND :NEW.BUDMODE = 'E' THEN
        UPDATE BUDGET_PLANNER_HEAD_SUM SET EXTVALUE=EXTVALUE+:NEW.APPRVAL WHERE BUDYEAR=:NEW.APRYEAR AND BRNCODE=:NEW.BRNCODE AND EXPSRNO=:NEW.EXPSRNO;
     END IF;
 end if;

 if UPDATING then

     IF :OLD.DELETED='N' AND :NEW.DELETED='Y' AND ( :OLD.BUDMODE = 'F' or :OLD.BUDMODE = 'R' ) THEN
        UPDATE BUDGET_PLANNER_HEAD_SUM SET APPVALUE=APPVALUE-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BRNCODE=:OLD.BRNCODE AND EXPSRNO=:OLD.EXPSRNO;
        UPDATE BUDGET_PLANNER_HEAD_SUM SET RESVALUE=RESVALUE+:OLD.APPRVAL WHERE BUDYEAR=:old.APRYEAR AND BRNCODE=:old.BRNCODE AND EXPSRNO=:old.EXPSRNO;
     END IF;

     IF :OLD.DELETED='N' AND :NEW.DELETED='Y' AND :OLD.BUDMODE = 'E' THEN
        UPDATE BUDGET_PLANNER_HEAD_SUM SET EXTVALUE=EXTVALUE-:OLD.APPRVAL WHERE BUDYEAR=:OLD.APRYEAR AND BRNCODE=:OLD.BRNCODE AND EXPSRNO=:OLD.EXPSRNO;
     END IF;

     if :new.EDTUSER <> '1000001' AND :NEW.EDTUSER IS NOT NULL THEN
       if nvl(:new.APPRVAL,0)<>nvl(:old.APPRVAL,0)  and nvl(:new.APPRVAL,-1)>=0 and ( :OLD.BUDMODE = 'F' or :OLD.BUDMODE = 'R' )   then
         UPDATE BUDGET_PLANNER_HEAD_SUM SET APPVALUE=APPVALUE-(nvl(:old.APPRVAL,0)-nvl(:New.APPRVAL,0)) WHERE BUDYEAR=:OLD.APRYEAR AND BRNCODE=:OLD.BRNCODE AND EXPSRNO=:OLD.EXPSRNO;
         UPDATE BUDGET_PLANNER_HEAD_SUM SET RESVALUE=BUDVALUE-APPVALUE WHERE BUDYEAR=:old.APRYEAR AND BRNCODE=:old.BRNCODE AND EXPSRNO=:old.EXPSRNO;
       end if;

       if nvl(:new.APPRVAL,0)<>nvl(:old.APPRVAL,0)  and nvl(:new.APPRVAL,-1)>=0 and :OLD.BUDMODE = 'E'  then
         UPDATE BUDGET_PLANNER_HEAD_SUM SET EXTVALUE=EXTVALUE-(nvl(:old.APPRVAL,0)-nvl(:New.APPRVAL,0)) WHERE BUDYEAR=:OLD.APRYEAR AND BRNCODE=:OLD.BRNCODE AND EXPSRNO=:OLD.EXPSRNO;
       end if;
     end if;
 end if;
END;



================================********************=============================

CREATE OR REPLACE TRIGGER "TRANDATA"."BUDGET_PLANNER_BRANCH_TRG" 
    AFTER
INSERT
OR UPDATE ON "APPROVAL_BUDGET_PLANNER" FOR EACH ROW declare
BEGIN
  if UPDATING then

     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' AND :OLD.BUDMODE = 'F' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET PURTVAL=PURTVAL+:NEW.APPRVAL WHERE BRNCODE=:NEW.BRNCODE AND TARYEAR+1=SUBSTR(:NEW.APPYEAR,3,2) AND TARMONT=:NEW.APPMNTH  AND TARNUMB=:NEW.TARNUMB ;
     END IF;

     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' AND :OLD.BUDMODE = 'R' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET RESRVAL=RESRVAL+:NEW.APPRVAL WHERE BRNCODE=:NEW.BRNCODE AND TARYEAR+1=SUBSTR(:NEW.APPYEAR,3,2) AND TARMONT=:NEW.APPMNTH  AND TARNUMB=:NEW.TARNUMB ;
     END IF;

     IF :OLD.APPMODE='N' AND :NEW.APPMODE='Y' AND :OLD.BUDMODE = 'E' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET EXTRVAL=EXTRVAL+:NEW.APPRVAL WHERE BRNCODE=:NEW.BRNCODE AND TARYEAR+1=SUBSTR(:NEW.APPYEAR,3,2) AND TARMONT=:NEW.APPMNTH  AND TARNUMB=:NEW.TARNUMB ;
     END IF;

     IF :OLD.DELETED='N' AND :NEW.DELETED='Y' and :OLD.APPMODE='Y' AND :OLD.BUDMODE = 'F' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET PURTVAL=PURTVAL-:OLD.APPRVAL WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
      END IF;
     IF :OLD.DELETED='N' AND :NEW.DELETED='Y' and :OLD.APPMODE='Y' AND :OLD.BUDMODE = 'R' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET RESRVAL=RESRVAL-:OLD.APPRVAL WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
      END IF;
     IF :OLD.DELETED='N' AND :NEW.DELETED='Y' and :OLD.APPMODE='Y' AND :OLD.BUDMODE = 'E' THEN
        UPDATE BUDGET_PLANNER_BRANCH SET EXTRVAL=EXTRVAL-:OLD.APPRVAL WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
      END IF;


     -- if nvl(:new.APPRVAL,0)<>nvl(:old.APPRVAL,0) and nvl(:new.APPRVAL,-1)>=0 AND :NEW.APPMODE='Y' then
     --   if :OLD.BUDMODE = 'F' then
     --       UPDATE BUDGET_PLANNER_BRANCH SET PURTVAL=PURTVAL-(nvl(:old.APPRVAL,0)-nvl(:new.APPRVAL,0)) WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
     --    end if;

     --    if :OLD.BUDMODE = 'R' then
     --       UPDATE BUDGET_PLANNER_BRANCH SET RESRVAL=RESRVAL-(nvl(:old.APPRVAL,0)-nvl(:new.APPRVAL,0)) WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
     --    end if;

     ---    if :OLD.BUDMODE = 'E' then
     ---       UPDATE BUDGET_PLANNER_BRANCH SET EXTRVAL=EXTRVAL-(nvl(:old.APPRVAL,0)-nvl(:new.APPRVAL,0)) WHERE BRNCODE=:OLD.BRNCODE AND TARYEAR+1=SUBSTR(:OLD.APPYEAR,3,2) AND TARMONT=:OLD.APPMNTH  AND TARNUMB=:OLD.TARNUMB;
     ---    end if;

 --    end if;

 end if;
END;

